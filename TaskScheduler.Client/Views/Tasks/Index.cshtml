@using TaskScheduler.Core.Models
@using DevExtreme.AspNet.Mvc

<h2>Task Scheduler Management</h2>

@(Html.DevExtreme().DataGrid<ScheduledTask>()
    .ID("gridTasks")
    .DataSource(d => d.Mvc().Controller("Tasks").LoadAction("Get").InsertAction("Post").UpdateAction("Put").DeleteAction("Delete").Key("Id"))
    .ShowBorders(true)
    .Paging(p => p.PageSize(10))
    .Editing(e => e.Mode(GridEditMode.Popup).AllowAdding(true).AllowUpdating(true).AllowDeleting(true))
    .Columns(columns => {
        columns.AddFor(m => m.Name);
        columns.AddFor(m => m.ApiUrl);
        columns.AddFor(m => m.IsActive);
    })
    .MasterDetail(md => md
        .Enabled(true)
        .Template(@<text>
            <div class="master-detail-caption">Trigger Settings for: <%= data.Name %></div>
            
            @(Html.DevExtreme().DataGrid<TaskTrigger>()
                .DataSource(d => d.Mvc()
                    .Controller("TaskTriggers")
                    .LoadAction("Get")
                    .LoadParams(new { taskId = new JS("data.Id") }) // ส่ง TaskId ไปเพื่อดึงเฉพาะ Trigger ของงานนี้
                    .InsertAction("Post")
                    .UpdateAction("Put")
                    .DeleteAction("Delete")
                    .Key("Id")
                )
                .OnInitNewRow("function(e) { e.data.TaskId = data.Id; }") // กำหนด TaskId อัตโนมัติเวลาสร้างใหม่
                .ShowBorders(true)
                .Editing(e => e.Mode(GridEditMode.Row).AllowAdding(true).AllowUpdating(true).AllowDeleting(true))
                .Columns(cols => {
                    cols.AddFor(t => t.TriggerType)
                        .Lookup(l => l.DataSource(new[] { "Interval", "Daily" }));
                        
                    cols.AddFor(t => t.IntervalMinutes)
                        .Caption("Every (Minutes)")
                        .ValidationRules(r => r.AddCustom().ValidationCallback("validateInterval")); // เพิ่ม Validation ตามประเภท

                    cols.AddFor(t => t.StartTime)
                        .DataType(GridColumnDataType.String)
                        .Format("HH:mm");
                    
                    cols.AddFor(t => t.NextExecutionTime)
                        .AllowEditing(false) // ห้ามแก้ ให้ระบบคำนวณเอง
                        .Format("dd/MM/yyyy HH:mm:ss")
                        .SortOrder(SortOrder.Asc);
                        
                    cols.AddFor(t => t.IsActive);
                })
            )
        </text>)
    )
)

<script>
    function validateInterval(e) {
        // ตัวอย่าง: ถ้าเลือก Interval ต้องใส่ค่า > 0
        var data = e.data;
        if (data.TriggerType === "Interval" && (!data.IntervalMinutes || data.IntervalMinutes <= 0)) {
            return false;
        }
        return true;
    }
</script>