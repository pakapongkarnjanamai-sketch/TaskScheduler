@{
    ViewData["Title"] = "Task Scheduler Management";
}

<div class="container-fluid full-height-container mt-3">
    <div id="gridTasks"></div>
    <div id="popupHistory"></div>
    <div id="popupStepLogs"></div>
</div>

@section Scripts {
    <script>
        $(function () {
            // var serviceUrl = "https://localhost:7253/api/";
            var serviceUrl = "https://ap-ntc2138-qawb/TaskScheduler/Service/api/";

            // ============ STORES ============
            var tasksStore = DevExpress.data.AspNet.createStore({
                key: "Id",
                loadUrl: serviceUrl + "Tasks/Get",
                insertUrl: serviceUrl + "Tasks/Post",
                updateUrl: serviceUrl + "Tasks/Put",
                deleteUrl: serviceUrl + "Tasks/Delete",
                onBeforeSend: function (method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            var stepsStore = DevExpress.data.AspNet.createStore({
                key: "Id",
                loadUrl: serviceUrl + "Steps/Get",
                insertUrl: serviceUrl + "Steps/Post",
                updateUrl: serviceUrl + "Steps/Put",
                deleteUrl: serviceUrl + "Steps/Delete",
                onBeforeSend: function (method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            var triggersStore = DevExpress.data.AspNet.createStore({
                key: "Id",
                loadUrl: serviceUrl + "Schedules/Get",
                insertUrl: serviceUrl + "Schedules/Post",
                updateUrl: serviceUrl + "Schedules/Put",
                deleteUrl: serviceUrl + "Schedules/Delete",
                onBeforeSend: function (method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            var logsStore = DevExpress.data.AspNet.createStore({
                key: "Id",
                loadUrl: serviceUrl + "TaskExecutionLogs/Get",
                onBeforeSend: function (method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            var stepLogsStore = DevExpress.data.AspNet.createStore({
                key: "Id",
                loadUrl: serviceUrl + "StepExecutionLogs/Get",
                onBeforeSend: function (method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            var connection = new signalR.HubConnectionBuilder()
                .withUrl("https://ap-ntc2138-qawb/TaskScheduler/Service/taskHub") 
                // .withUrl("https://localhost:7253/taskHub") 
                .withAutomaticReconnect()
                .build();
                connection.on("ReceiveTaskUpdate", function (taskId, data) {
                console.log("SignalR Update Received:", taskId);
                console.log("Data Update:", data);
                // ใช้ความสามารถ push ของ Store เพื่ออัปเดตข้อมูลใน Grid ทันทีโดยไม่ต้องโหลดใหม่
                tasksStore.push([{
                    type: "update",
                    key: taskId,
                    data: data // ข้อมูล object ที่ส่งมาจาก Backend (LastStatus, LastRun, NextRun)
                }]);
            });

            // เริ่มการเชื่อมต่อ
            connection.start().then(function () {
                console.log("SignalR Connected!");
            }).catch(function (err) {
                return console.error(err.toString());
            });

            // ============ MAIN GRID ============
            $("#gridTasks").dxDataGrid({
                dataSource: tasksStore,
                showBorders: true,
                columnAutoWidth: true,
                rowAlternationEnabled: true,
                height: "100%",
                scrolling: { mode: "virtual" },

                searchPanel: {
                    visible: true,
                    width: 240,
                    placeholder: "Search..."
                },

                headerFilter: {
                    visible: true
                },

                filterRow: {
                    visible: true
                },

             
                // Master-Detail
                masterDetail: {
                    enabled: true,
                    template: function(container, options) {
                        var taskId = options.key;

                        $("<div>").dxTabPanel({
                            items: [
                                {
                                    title: "Steps",
                                    template: function(data, index, element) {
                                        createStepsGrid(element, taskId);
                                    }
                                },
                                {
                                    title: "Schedules",
                                    template: function(data, index, element) {
                                        createTriggersGrid(element, taskId);
                                    }
                                }
                            ],
                            height: 400
                        }).appendTo(container);
                    }
                },

                // Editing
                editing: {
                    mode: "popup",
                    allowAdding: true,
                    allowUpdating: true,
                    allowDeleting: true,
                    useIcons: true,
                    popup: {
                        title: "Task Information",
                        showTitle: true,
                            width: 800,
                            height: 650
                    },
                    form: {
                        items: [
                            {
                                    itemType: "group",
                                    colSpan: 2,
                                    items: [
                            {
                                itemType: "group",
                                caption: "General",
                                items: ["Name", "IsActive"]
                            },
                            {
                                itemType: "group",
                                caption: "Details",
                                items: [{
                                    dataField: "Description",
                                    editorType: "dxTextArea",
                                    editorOptions: {
                                        height: 100
                                    }
                                }]
                            }
                        ]     }
                        ]
                    }
                },

                // Columns
              columns: [
                    {
                        dataField: "Id",
                        width: 70,
                        allowEditing: false
                    },
                     {
                        dataField: "IsActive",
                        caption: "Active",
                        dataType: "boolean",
                        width: 80
                    },
                    {
                        dataField: "Name",
                        caption: "Task Name",
                        validationRules: [{ type: "required" }]
                    },
                    {
                        dataField: "Description",
                        visible: true
                    },
                    // --- เพิ่มส่วนนี้ ---
                    {
                        dataField: "LastStatus",
                        caption: "Status",
                        width: 100,
                        alignment: "center",
                        allowEditing: false, // ห้ามแก้ไขค่านี้
                        cellTemplate: function(container, options) {
                            var status = options.value;
                            if (!status) return;

                            var color = "grey";
                            if (status === "Success") color = "#28a745";      // สีเขียว
                            else if (status === "Failed") color = "#dc3545";  // สีแดง
                            else if (status === "Running") color = "#007bff"; // สีน้ำเงิน

                            $("<span>")
                                .css("color", color)
                                .css("font-weight", "bold")
                                .text(status)
                                .appendTo(container);
                        }
                    },
                    {
                        dataField: "LastExecutionTime",
                        caption: "Last Run",
                        dataType: "datetime",
                        format: "dd/MM/yyyy HH:mm",
                        width: 140,
                        allowEditing: false
                    },
                    {
                        dataField: "NextExecutionTime",
                        caption: "Next Run",
                        dataType: "datetime",
                        format: "dd/MM/yyyy HH:mm",
                        width: 140,
                        allowEditing: false
                    },
                    // ------------------
                   
                    {
                        dataField: "UpdatedAt",
                        caption: "Last Updated",
                        dataType: "datetime",
                        format: "dd/MM/yyyy HH:mm",
                        allowEditing: false,
                        width: 150
                    },
                       
        {
            type: "buttons",
            width: 150, // ปรับความกว้างเพิ่มเล็กน้อยให้พอดีปุ่ม
            buttons: [
                "edit",
                "delete",
                {
                    hint: "History",
                    icon: "clock",
                    onClick: function(e) {
                        showHistory(e.row.data.Id, e.row.data.Name);
                    }
                },
                // --- เพิ่มปุ่ม Step Logs ตรงนี้ ---
                {
                    hint: "Step Logs",
                    icon: "menu", // หรือใช้ icon 'list' ก็ได้
                    onClick: function(e) {
                        showStepLogs(e.row.data.Id, e.row.data.Name);
                    }
                }
            ]
        }
        
                ],

                // Toolbar
                onToolbarPreparing: function(e) {
                    e.toolbarOptions.items.unshift({
                        location: "after",
                        widget: "dxButton",
                        options: {
                            icon: "refresh",
                            hint: "Refresh",
                            onClick: function() {
                                e.component.refresh();
                            }
                        }
                    });
                }
            });

            // ============ STEPS GRID ============
            function createStepsGrid(container, taskId) {
                $("<div>").dxDataGrid({
                    dataSource: {
                        store: stepsStore,
                        filter: ["TaskId", "=", taskId]
                    },
                    remoteOperations: false,
                    showBorders: true,
                    columnAutoWidth: true,

                    editing: {
                        mode: "popup",
                        allowAdding: true,
                        allowUpdating: true,
                        allowDeleting: true,
                        useIcons: true,
                        popup: {
                            title: "Step Configuration",
                            showTitle: true,
                            width: 800,
                            height: 650
                        },
                        form: {
                            items: [ {
                                    itemType: "group",
                                    colSpan: 2,
                                    items: [
                                {
                                    itemType: "group",
                                    caption: "Basic Info",
                                    colSpan: 2,
                                    items: [
                                        "Order",
                                        "Name","Description",
                                        "HttpMethod"
                                    ]
                                },
                                {
                                    itemType: "group",
                                    caption: "Request",
                                    colSpan: 2,
                                    items: [
                                        "ApiUrl",
                                        {
                                            dataField: "Headers",
                                            editorType: "dxTextArea",
                                            editorOptions: { height: 80 }
                                        },
                                        {
                                            dataField: "Body",
                                            editorType: "dxTextArea",
                                            editorOptions: { height: 100 }
                                        }
                                    ]
                                }
                            ]
                            }
                            ]
                        }
                    },

                    columns: [
                        {
                            dataField: "Order",
                            caption: "#",
                            width: 60,
                            dataType: "number",
                            sortOrder: "asc",
                            validationRules: [{ type: "required" }]
                        },
                        {
                            dataField: "Name",
                            caption: "Step Name",
                            validationRules: [{ type: "required" }]
                        },
                         {
                            dataField: "Description",
                            caption: "Description",
                        },
                        {
                            dataField: "HttpMethod",
                            caption: "Method",
                            width: 100,
                            lookup: {
                                dataSource: ["GET", "POST", "PUT", "DELETE", "PATCH"]
                            },
                            validationRules: [{ type: "required" }]
                        },
                        {
                            dataField: "ApiUrl",
                            caption: "URL",
                            validationRules: [{ type: "required" }]
                        },
                        {
                            dataField: "Headers",
                            visible: false
                        },
                        {
                            dataField: "Body",
                            visible: false
                        }
                    ],

                    onInitNewRow: function(e) {
                        e.data.TaskId = taskId;
                        e.data.Order = 1;
                        e.data.HttpMethod = "GET";
                    }
                }).appendTo(container);
            }

            // ============ TRIGGERS GRID ============
            function createTriggersGrid(container, taskId) {
                $("<div>").dxDataGrid({
                    dataSource: {
                        store: triggersStore,
                        filter: ["TaskId", "=", taskId]
                    },
                    remoteOperations: false,
                    showBorders: true,
                    columnAutoWidth: true,
                    width: "100%",
                    height: "100%",
                    scrolling: { mode: "virtual" },
                    editing: {
                        mode: "row",
                        allowAdding: true,
                        allowUpdating: true,
                        allowDeleting: true,
                        useIcons: true
                    },

                    columns: [
                         {
                            dataField: "Name",
                            caption: "Schedules Name",
                            validationRules: [{ type: "required" }]
                        },
                         {
                            dataField: "Description",
                            caption: "Description",
                        },
                        {
                            dataField: "IsActive",
                            caption: "Active",
                            dataType: "boolean",
                            width: 80
                        },
                        {
                            dataField: "TriggerType",
                            caption: "Type",
                            width: 120,
                            lookup: {
                                dataSource: ["Interval", "Daily", "Weekly", "Monthly"]
                            },
                            validationRules: [{ type: "required" }]
                        },
                                      {
            dataField: "IntervalTime",
            caption: "Interval",
            dataType: "number",
            width: 140, // ปรับความกว้างเพิ่มเล็กน้อยให้พอดีข้อความภาษาอังกฤษ
            alignment: "center",

            // ใช้ cellTemplate เพื่อตรวจสอบ TriggerType และใส่หน่วยภาษาอังกฤษให้ถูกต้อง
            cellTemplate: function(container, options) {
                var value = options.value;

                // ถ้าไม่มีค่า ให้แสดงขีด "-"
                if (value === null || value === undefined) {
                    $("<span>").text("-").appendTo(container);
                    return;
                }

                // ดึงค่า TriggerType ของแถวนั้นๆ มาตรวจสอบ
                var type = options.data.TriggerType;
                var unit = "";

                // กำหนดหน่วยภาษาอังกฤษตามประเภท
                if (type === "Interval") {
                    unit = " Minutes";
                } else if (type === "Daily") {
                    unit = " Days";
                } else if (type === "Weekly") {
                    unit = " Weeks";
                } else if (type === "Monthly") {
                    unit = " Months";
                }

                // แสดงผล ตัวเลข + หน่วย (เช่น "30 Minutes", "1 Days")
                $("<span>")
                    .text(value + unit)
                    .appendTo(container);
            },

            // ส่วนของการแก้ไขข้อมูล (Editor)
            editorOptions: {
                min: 1,                 // ห้ามต่ำกว่า 1
                showSpinButtons: true,  // มีปุ่มลูกศรขึ้นลง
                step: 1
            }
        },

                               {
            dataField: "StartTime",
            caption: "Start Time",
            width: 120,
            alignment: "center", // จัดกึ่งกลางเพื่อความสวยงาม
            editorType: "dxDateBox",

            // 1. จัดรูปแบบการแสดงผลในตาราง (Grid) ให้เป็น HH:mm
            customizeText: function(cellInfo) {
                if (!cellInfo.value) return "";
                // ค่า TimeSpan มักจะมาเป็น string "HH:mm:ss" เราตัดเอาแค่ 5 ตัวแรก
                return cellInfo.value.substring(0, 5);
            },

            // 2. ปรับปรุงตัวเลือกเวลา (Editor)
            editorOptions: {
                type: "time",
                displayFormat: "HH:mm",     
                pickerType: "calendar",      
                interval: 30,              
                useMaskBehavior: true,    
                invalidDateMessage: "The time must have the following format: HH:mm"
            }
        },
                        {
                            dataField: "NextExecutionTime",
                            caption: "Next Run",
                            dataType: "datetime",
                            format: "dd/MM/yyyy HH:mm",
                            allowEditing: false,
                            width: 150
                        },
                        
                    ],

                    onInitNewRow: function(e) {
                        e.data.TaskId = taskId;
                        e.data.TriggerType = "Interval";
                        e.data.IsActive = true;
                    }
                }).appendTo(container);
            }
                    // ============ STEP LOGS POPUP ============
        function showStepLogs(taskId, taskName) {
            var popup = $("#popupStepLogs").dxPopup({
                title: "Step Logs: " + taskName,
                visible: true,
                width: 1000,
                height: 650,
 
                contentTemplate: function(content) {
                    $("<div>").dxDataGrid({
                        dataSource: {
                            store: stepLogsStore,
                            // Filter ผ่าน Relation: TaskExecutionLog -> TaskId
                            filter: ["TaskExecutionLog.TaskId", "=", taskId],
                            sort: [{ selector: "StartTime", desc: true }]
                        },
                        showBorders: true,
                        columnAutoWidth: true,
                        rowAlternationEnabled: true,
                        height: "100%",
                scrolling: { mode: "virtual" },
                        columns: [
                            {
                                dataField: "StartTime",
                                caption: "Start Time",
                                dataType: "datetime",
                                format: "dd/MM/yyyy HH:mm:ss",
                                width: 160
                            },

                            {
                                dataField: "StepName",
                                caption: "Step Name",
                                width: 150
                            },
                            {
                                dataField: "Order",
                                caption: "#",
                                width: 50,
                                alignment: "center"
                            },
                            {
                                dataField: "Status",
                                caption: "Status",
                                width: 100,
                               
                                   cellTemplate: function(container, options) {
                            var status = options.value;
                            if (!status) return;

                            var color = "grey";
                            if (status === "Success") color = "#28a745";      // สีเขียว
                            else if (status === "Failed") color = "#dc3545";  // สีแดง
                            else if (status === "Error") color = "#dc3545";  // สีแดง
                            else if (status === "Running") color = "#007bff"; // สีน้ำเงิน

                            $("<span>")
                                .css("color", color)
                                .css("font-weight", "bold")
                                .text(status)
                                .appendTo(container);
                        }
                            },
                            {
                                dataField: "ResponseMessage",
                                caption: "Message",
                                // ให้ตัดข้อความถ้ายาวเกินไป
                                cellTemplate: function(container, options) {
                                    var text = options.value || "";
                                    $("<div>")
                                        .attr("title", text) // tooltip
                                        .text(text)
                                        .appendTo(container);
                                }
                            },
                            {
                                dataField: "EndTime",
                                caption: "End Time",
                                dataType: "datetime",
                                format: "HH:mm:ss",
                                width: 100,
                                visible: false // ซ่อนไว้ก่อน เปิดดูได้ถ้าต้องการ
                            }
                        ],

                     

                    }).appendTo(content);
                }
            }).dxPopup("instance");
        }
            // ============ HISTORY POPUP ============
            function showHistory(taskId, taskName) {
                $("#popupHistory").dxPopup({
                    title: "Execution History: " + taskName,
                    visible: true,
                     width: 1000,
                    height: 650,
                    contentTemplate: function(content) {
                        $("<div>").dxDataGrid({
                            dataSource: {
                                store: logsStore,
                                filter: ["TaskId", "=", taskId],
                                sort: [{ selector: "StartTime", desc: true }]
                            },
                            showBorders: true,
                            columnAutoWidth: true,
                            rowAlternationEnabled: true,

                            height: "100%",
                            scrolling: { mode: "virtual" },

                            columns: [
                                {
                                    dataField: "StartTime",
                                    caption: "Start Time",
                                    dataType: "datetime",
                                    format: "dd/MM/yyyy HH:mm:ss",
                                    width: 160
                                },
                                {
                                    dataField: "EndTime",
                                    caption: "End Time",
                                    dataType: "datetime",
                                    format: "HH:mm:ss",
                                    width: 100
                                },
                                {
                                    dataField: "Status",
                                    width: 100,
                              
                                    cellTemplate: function(container, options) {
                            var status = options.value;
                            if (!status) return;

                            var color = "grey";
                            if (status === "Success") color = "#28a745";      // สีเขียว
                            else if (status === "Failed") color = "#dc3545";  // สีแดง
                            else if (status === "Error") color = "#dc3545";  // สีแดง
                            else if (status === "Running") color = "#007bff"; // สีน้ำเงิน

                            $("<span>")
                                .css("color", color)
                                .css("font-weight", "bold")
                                .text(status)
                                .appendTo(container);
                        }
                                },
                                {
                                    dataField: "ResponseMessage",
                                    caption: "Message"
                                }
                            ]
                        }).appendTo(content);
                    },

                   
                });
            }
        });
    </script>
}
