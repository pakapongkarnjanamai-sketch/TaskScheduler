@{
    ViewData["Title"] = "Task Scheduler Management";
}

<div class="container full-height-container mt-3">
    <div id="gridTasks"></div>
    <div id="popupHistory"></div>
    <div id="popupStepLogs"></div>
</div>

@section Scripts {
    <script>
        $(function () {
            var serviceUrl = "https://localhost:7253/api/";

            // ============ STORES ============
            var tasksStore = DevExpress.data.AspNet.createStore({
                key: "Id",
                loadUrl: serviceUrl + "Tasks/Get",
                insertUrl: serviceUrl + "Tasks/Post",
                updateUrl: serviceUrl + "Tasks/Put",
                deleteUrl: serviceUrl + "Tasks/Delete",
                onBeforeSend: function (method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            var stepsStore = DevExpress.data.AspNet.createStore({
                key: "Id",
                loadUrl: serviceUrl + "TaskSteps/Get",
                insertUrl: serviceUrl + "TaskSteps/Post",
                updateUrl: serviceUrl + "TaskSteps/Put",
                deleteUrl: serviceUrl + "TaskSteps/Delete",
                onBeforeSend: function (method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            var triggersStore = DevExpress.data.AspNet.createStore({
                key: "Id",
                loadUrl: serviceUrl + "TaskTriggers/Get",
                insertUrl: serviceUrl + "TaskTriggers/Post",
                updateUrl: serviceUrl + "TaskTriggers/Put",
                deleteUrl: serviceUrl + "TaskTriggers/Delete",
                onBeforeSend: function (method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            var logsStore = DevExpress.data.AspNet.createStore({
                key: "Id",
                loadUrl: serviceUrl + "TaskExecutionLogs/Get",
                onBeforeSend: function (method, ajaxOptions) {
                    ajaxOptions.xhrFields = { withCredentials: true };
                }
            });

            var stepLogsStore = DevExpress.data.AspNet.createStore({
            key: "Id",
            loadUrl: serviceUrl + "TaskStepExecutionLogs/Get",
            onBeforeSend: function (method, ajaxOptions) {
                ajaxOptions.xhrFields = { withCredentials: true };
            }
        });
            // ============ MAIN GRID ============
            $("#gridTasks").dxDataGrid({
                dataSource: tasksStore,
                showBorders: true,
                columnAutoWidth: true,
                rowAlternationEnabled: true,
                height: "100%",
                scrolling: { mode: "virtual" },

                searchPanel: {
                    visible: true,
                    width: 240,
                    placeholder: "Search..."
                },

                headerFilter: {
                    visible: true
                },

                filterRow: {
                    visible: true
                },

                export: {
                    enabled: true,
                    fileName: "Tasks"
                },

                // Master-Detail
                masterDetail: {
                    enabled: true,
                    template: function(container, options) {
                        var taskId = options.key;

                        $("<div>").dxTabPanel({
                            items: [
                                {
                                    title: "Workflow Steps",
                                    template: function(data, index, element) {
                                        createStepsGrid(element, taskId);
                                    }
                                },
                                {
                                    title: "Schedules",
                                    template: function(data, index, element) {
                                        createTriggersGrid(element, taskId);
                                    }
                                }
                            ],
                            height: 400
                        }).appendTo(container);
                    }
                },

                // Editing
                editing: {
                    mode: "popup",
                    allowAdding: true,
                    allowUpdating: true,
                    allowDeleting: true,
                    useIcons: true,
                    popup: {
                        title: "Task Information",
                        showTitle: true,
                        width: 600,
                        height: 400
                    },
                    form: {
                        items: [
                            {
                                itemType: "group",
                                caption: "General",
                                items: ["Name", "IsActive"]
                            },
                            {
                                itemType: "group",
                                caption: "Details",
                                items: [{
                                    dataField: "Description",
                                    editorType: "dxTextArea",
                                    editorOptions: {
                                        height: 100
                                    }
                                }]
                            }
                        ]
                    }
                },

                // Columns
                columns: [
                    {
                        dataField: "Id",
                        width: 70,
                        allowEditing: false
                    },
                    {
                        dataField: "Name",
                        caption: "Task Name",
                        validationRules: [{ type: "required" }]
                    },
                    {
                        dataField: "Description",
                        visible: false
                    },
                    {
                        dataField: "IsActive",
                        caption: "Active",
                        dataType: "boolean",
                        width: 80
                    },
                    {
                        dataField: "UpdatedAt",
                        caption: "Last Updated",
                        dataType: "datetime",
                        format: "dd/MM/yyyy HH:mm",
                        allowEditing: false,
                        width: 150
                    },
                       
        {
            type: "buttons",
            width: 150, // ปรับความกว้างเพิ่มเล็กน้อยให้พอดีปุ่ม
            buttons: [
                "edit",
                "delete",
                {
                    hint: "History",
                    icon: "clock",
                    onClick: function(e) {
                        showHistory(e.row.data.Id, e.row.data.Name);
                    }
                },
                // --- เพิ่มปุ่ม Step Logs ตรงนี้ ---
                {
                    hint: "Step Logs",
                    icon: "menu", // หรือใช้ icon 'list' ก็ได้
                    onClick: function(e) {
                        showStepLogs(e.row.data.Id, e.row.data.Name);
                    }
                }
            ]
        }
        
                ],

                // Toolbar
                onToolbarPreparing: function(e) {
                    e.toolbarOptions.items.unshift({
                        location: "after",
                        widget: "dxButton",
                        options: {
                            icon: "refresh",
                            hint: "Refresh",
                            onClick: function() {
                                e.component.refresh();
                            }
                        }
                    });
                }
            });

            // ============ STEPS GRID ============
            function createStepsGrid(container, taskId) {
                $("<div>").dxDataGrid({
                    dataSource: {
                        store: stepsStore,
                        filter: ["TaskId", "=", taskId]
                    },
                    remoteOperations: false,
                    showBorders: true,
                    columnAutoWidth: true,

                    editing: {
                        mode: "popup",
                        allowAdding: true,
                        allowUpdating: true,
                        allowDeleting: true,
                        useIcons: true,
                        popup: {
                            title: "Step Configuration",
                            showTitle: true,
                            width: 700,
                            height: 550
                        },
                        form: {
                            items: [
                                {
                                    itemType: "group",
                                    caption: "Basic Info",
                                    colCount: 2,
                                    items: [
                                        "Order",
                                        "Name",
                                        "HttpMethod"
                                    ]
                                },
                                {
                                    itemType: "group",
                                    caption: "Request",
                                    items: [
                                        "ApiUrl",
                                        {
                                            dataField: "Headers",
                                            editorType: "dxTextArea",
                                            editorOptions: { height: 80 }
                                        },
                                        {
                                            dataField: "Body",
                                            editorType: "dxTextArea",
                                            editorOptions: { height: 100 }
                                        }
                                    ]
                                }
                            ]
                        }
                    },

                    columns: [
                        {
                            dataField: "Order",
                            caption: "#",
                            width: 60,
                            dataType: "number",
                            sortOrder: "asc",
                            validationRules: [{ type: "required" }]
                        },
                        {
                            dataField: "Name",
                            caption: "Step Name",
                            validationRules: [{ type: "required" }]
                        },
                        {
                            dataField: "HttpMethod",
                            caption: "Method",
                            width: 100,
                            lookup: {
                                dataSource: ["GET", "POST", "PUT", "DELETE", "PATCH"]
                            },
                            validationRules: [{ type: "required" }]
                        },
                        {
                            dataField: "ApiUrl",
                            caption: "URL",
                            validationRules: [{ type: "required" }]
                        },
                        {
                            dataField: "Headers",
                            visible: false
                        },
                        {
                            dataField: "Body",
                            visible: false
                        }
                    ],

                    onInitNewRow: function(e) {
                        e.data.TaskId = taskId;
                        e.data.Order = 1;
                        e.data.HttpMethod = "GET";
                    }
                }).appendTo(container);
            }

            // ============ TRIGGERS GRID ============
            function createTriggersGrid(container, taskId) {
                $("<div>").dxDataGrid({
                    dataSource: {
                        store: triggersStore,
                        filter: ["TaskId", "=", taskId]
                    },
                    remoteOperations: false,
                    showBorders: true,
                    columnAutoWidth: true,
                    width: "100%",
                    height: "100%",
                scrolling: { mode: "virtual" },
                    editing: {
                        mode: "row",
                        allowAdding: true,
                        allowUpdating: true,
                        allowDeleting: true,
                        useIcons: true
                    },

                    columns: [
                        {
                            dataField: "TriggerType",
                            caption: "Type",
                            width: 120,
                            lookup: {
                                dataSource: ["Interval", "Daily", "Weekly", "Monthly"]
                            },
                            validationRules: [{ type: "required" }]
                        },
                        {
                            dataField: "IntervalMinutes",
                            caption: "Interval (Min)",
                            dataType: "number",
                            width: 120,
                            editorOptions: {
                                min: 1
                            }
                        },
                        {
                            dataField: "StartTime",
                            caption: "Start Time",
                            width: 120
                        },
                        {
                            dataField: "NextExecutionTime",
                            caption: "Next Run",
                            dataType: "datetime",
                            format: "dd/MM/yyyy HH:mm",
                            allowEditing: false,
                            width: 150
                        },
                        {
                            dataField: "IsActive",
                            caption: "Active",
                            dataType: "boolean",
                            width: 80
                        }
                    ],

                    onInitNewRow: function(e) {
                        e.data.TaskId = taskId;
                        e.data.TriggerType = "Interval";
                        e.data.IsActive = true;
                    }
                }).appendTo(container);
            }
                    // ============ STEP LOGS POPUP ============
        function showStepLogs(taskId, taskName) {
            var popup = $("#popupStepLogs").dxPopup({
                title: "Step Logs: " + taskName,
                visible: true,
                width: 1000,
                height: 650,
 
                contentTemplate: function(content) {
                    $("<div>").dxDataGrid({
                        dataSource: {
                            store: stepLogsStore,
                            // Filter ผ่าน Relation: TaskExecutionLog -> TaskId
                            filter: ["TaskExecutionLog.TaskId", "=", taskId],
                            sort: [{ selector: "StartTime", desc: true }]
                        },
                        showBorders: true,
                        columnAutoWidth: true,
                        rowAlternationEnabled: true,
                        height: "100%",
                scrolling: { mode: "virtual" },
                        columns: [
                            {
                                dataField: "StartTime",
                                caption: "Start Time",
                                dataType: "datetime",
                                format: "dd/MM/yyyy HH:mm:ss",
                                width: 160
                            },
                            {
                                dataField: "StepName",
                                caption: "Step Name",
                                width: 150
                            },
                            {
                                dataField: "Order",
                                caption: "#",
                                width: 50,
                                alignment: "center"
                            },
                            {
                                dataField: "Status",
                                caption: "Status",
                                width: 100,
                                cellTemplate: function(container, options) {
                                    var color = options.value === "Success" ? "green" : "red";
                                    $("<span>")
                                        .css("color", color)
                                        .css("font-weight", "bold")
                                        .text(options.value)
                                        .appendTo(container);
                                }
                            },
                            {
                                dataField: "ResponseMessage",
                                caption: "Message",
                                // ให้ตัดข้อความถ้ายาวเกินไป
                                cellTemplate: function(container, options) {
                                    var text = options.value || "";
                                    $("<div>")
                                        .attr("title", text) // tooltip
                                        .text(text)
                                        .appendTo(container);
                                }
                            },
                            {
                                dataField: "EndTime",
                                caption: "End Time",
                                dataType: "datetime",
                                format: "HH:mm:ss",
                                width: 100,
                                visible: false // ซ่อนไว้ก่อน เปิดดูได้ถ้าต้องการ
                            }
                        ],

                     

                    }).appendTo(content);
                }
            }).dxPopup("instance");
        }
            // ============ HISTORY POPUP ============
            function showHistory(taskId, taskName) {
                $("#popupHistory").dxPopup({
                    title: "Execution History: " + taskName,
                    visible: true,
                     width: 1000,
                height: 650,
          
                  
                    contentTemplate: function(content) {
                        $("<div>").dxDataGrid({
                            dataSource: {
                                store: logsStore,
                                filter: ["TaskId", "=", taskId],
                                sort: [{ selector: "StartTime", desc: true }]
                            },
                            showBorders: true,
                            columnAutoWidth: true,
                            rowAlternationEnabled: true,

                            height: "100%",
                scrolling: { mode: "virtual" },

                            columns: [
                                {
                                    dataField: "StartTime",
                                    caption: "Start Time",
                                    dataType: "datetime",
                                    format: "dd/MM/yyyy HH:mm:ss",
                                    width: 160
                                },
                                {
                                    dataField: "EndTime",
                                    caption: "End Time",
                                    dataType: "datetime",
                                    format: "HH:mm:ss",
                                    width: 100
                                },
                                {
                                    dataField: "Status",
                                    width: 100
                                },
                                {
                                    dataField: "ResponseMessage",
                                    caption: "Message"
                                }
                            ]
                        }).appendTo(content);
                    },

                   
                });
            }
        });
    </script>
}
